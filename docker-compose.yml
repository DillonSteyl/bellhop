version: "3.8"

services:
  localstack:
    container_name: "${LOCALSTACK_DOCKER_NAME:-localstack-main}"
    image: localstack/localstack:3.4.0
    ports:
      - "127.0.0.1:4566:4566" # LocalStack Gateway
      - "127.0.0.1:4510-4559:4510-4559" # external services port range
    environment:
      # LocalStack configuration: https://docs.localstack.cloud/references/configuration/
      - DEBUG=${DEBUG:-0}
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"

  localstack-setup:
    depends_on:
      - localstack
    build:
      context: localstack
      dockerfile: Dockerfile
      args:
        - TERRAFORM_VERSION=1.8.5
    environment:
      - AWS_ENDPOINT_URL=http://localstack:4566
      - AWS_DEFAULT_REGION=ap-southeast-2
      - AWS_ACCESS_KEY_ID=123
      - AWS_SECRET_ACCESS_KEY=123456789
    volumes:
      - ./bellhop:/usr/src/bellhop
      - ./terraform:/usr/src/terraform
    command:
      - /bin/sh
      - -c
      - "
        cd /usr/src/terraform && \
        terraform init && \
        terraform apply -auto-approve \
        --target=aws_dynamodb_table.websocket_connections
        "

  bellhop:
    depends_on:
      - localstack
    build:
      context: bellhop
      dockerfile: Dockerfile
    volumes:
      - ./bellhop/src:/usr/src/bellhop
    environment:
      - AWS_DEFAULT_REGION=ap-southeast-2
      - AWS_ACCESS_KEY_ID=123
      - AWS_SECRET_ACCESS_KEY=123456789
